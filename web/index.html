<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>BB84 Visualization Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      margin: 20px; 
      background-color: #f5f7fa;
      color: #333;
    }
    h2 { text-align: center; color: #2c3e50; }
    
    /* Summary Cards */
    .summary-container {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      margin-bottom: 30px;
      justify-content: center;
    }
    .summary-card {
      flex: 1 1 200px;
      background-color: #fff;
      padding: 15px 20px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      text-align: center;
    }
    .summary-card h3 { margin: 0 0 10px; font-size: 18px; color: #2980b9; }
    .summary-card p { font-size: 16px; font-weight: bold; }

    /* Explanation Card */
    .explanation {
      margin-top: 20px; 
      background: #ffffff; 
      padding: 20px; 
      border-radius: 10px; 
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      line-height: 1.6;
    }

    /* Chart Card */
    #chartCard {
      margin-top: 30px;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    /* Table Styles */
    h3 { margin-top: 40px; text-align: center; color: #2c3e50; }
    table { 
      border-collapse: collapse; 
      width: 100%; 
      margin-top: 20px;
      background-color: #fff;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    th, td { 
      border-bottom: 1px solid #ddd; 
      padding: 10px; 
      text-align: center;
    }
    th { background-color: #2980b9; color: #fff; }
    tr:hover { background-color: #f1f1f1; }
    
    .alice { color: #3498db; font-weight: bold; }
    .bob { color: #27ae60; font-weight: bold; }
    .error { color: #e67e22; font-weight: bold; }
    .sifted { background-color: #d1ffd1; font-weight: bold; }
    .rejected { background-color: #ffd1d1; font-style: italic; }

    @media(max-width: 768px){
      .summary-container { flex-direction: column; }
    }
  </style>
</head>
<body>
  <h2>BB84 Quantum Key Distribution Dashboard</h2>

  <!-- Summary Cards -->
  <div class="summary-container" id="summaryCards"></div>

  <!-- Explanation -->
  <div class="explanation" id="explanation"></div>

  <!-- Chart Card -->
  <div id="chartCard">
    <canvas id="bb84Chart" width="900" height="400"></canvas>
  </div>

  <!-- Table -->
  <h3>Bits Table</h3>
  <table id="bitsTable">
    <thead>
      <tr>
        <th>Index</th>
        <th>Alice</th>
        <th>Bob</th>
        <th>Reason</th>
        <th>Sifted Key</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    fetch('http://127.0.0.1:8000/simulate')
      .then(res => res.json())
      .then(data => {

        // Summary Cards
        const summaryContainer = document.getElementById('summaryCards');
        const summaryItems = [
          { title: 'Total Bits', value: data.total_bits },
          { title: 'Sifted Key Length', value: data.sifted_key_length },
          { title: 'QBER', value: data.qber },
          { title: 'Eavesdropping Detected', value: data.eavesdropping_detected ? 'Yes' : 'No' }
        ];
        summaryContainer.innerHTML = '';
        summaryItems.forEach(item => {
          const card = document.createElement('div');
          card.className = 'summary-card';
          card.innerHTML = `<h3>${item.title}</h3><p>${item.value}</p>`;
          summaryContainer.appendChild(card);
        });

        // Explanation
        const explanation = `
          <p><span class="alice">Alice</span> generates random bits and chooses random bases (+ or ×).</p>
          <p><span class="bob">Bob</span> measures each photon using a random basis. Correct measurements are green, mismatches are orange.</p>
          <p>The <strong>sifted key</strong> is formed by keeping only the bits where Alice's and Bob's bases matched (highlighted in green). Rejected bits are highlighted in red with the reason.</p>
          <p>QBER tells how many bits were altered. If QBER &gt; 11%, eavesdropping is suspected.</p>
        `;
        document.getElementById('explanation').innerHTML = explanation;

        // Chart
        const ctx = document.getElementById('bb84Chart').getContext('2d');
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: data.alice_bits.map((_, i) => i + 1),
            datasets: [
              { label: 'Alice', data: data.alice_bits, backgroundColor: '#3498db' },
              { label: 'Bob', data: data.bob_results, 
                backgroundColor: data.bob_results.map((b,i)=>data.sifted_key_indices.includes(i)?'#27ae60':'#e67e22')
              }
            ]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'top' },
              tooltip: {
                callbacks: { label: ctx => `${ctx.dataset.label}: ${ctx.raw}` }
              }
            },
            scales: { y: { beginAtZero: true, max: 1 } }
          }
        });

        // Table
        const tbody = document.querySelector('#bitsTable tbody');
        tbody.innerHTML = '';
        for(let i=0; i<data.total_bits; i++){
          let reason = '';
          let siftedCell = '';
          let rowClass = '';
          if(data.sifted_key_indices.includes(i)){
            reason = 'Bases match → accepted';
            siftedCell = data.alice_bits[i];
            rowClass = 'sifted';
          } else {
            reason = 'Bases mismatch → rejected';
            rowClass = 'rejected';
          }

          const tr = document.createElement('tr');
          tr.className = rowClass;
          tr.innerHTML = `
            <td>${i+1}</td>
            <td class="alice">${data.alice_bits[i]}</td>
            <td class="${data.sifted_key_indices.includes(i)?'bob':'error'}">${data.bob_results[i]}</td>
            <td>${reason}</td>
            <td>${siftedCell}</td>
          `;
          tbody.appendChild(tr);
        }
      });
  </script>
</body>
</html>
